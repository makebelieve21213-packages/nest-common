# @makebelieve21213-packages/nest-common - Документация для ИИ

## Краткое описание

Общий ESM пакет с утилитами для NestJS микросервисов. Предоставляет единую систему обработки ошибок, валидации, логирования и базовые классы для HTTP, RPC и WebSocket контекстов. Все ошибки автоматически преобразуются между контекстами с сохранением типа и статус-кода.

## Технические детали пакета

- **Тип пакета**: ESM (`"type": "module"` в package.json)
- **Сборка**: TypeScript → tsc → tsc-alias → tsc-esm-fix
- **Module Resolution**: `bundler` (для гибкой работы с ESM и post-build инструментами)
- **Target**: ES2023
- **Module**: ESNext

## Структура пакета

```
src/
├── errors/                             # Классы ошибок для разных контекстов
│   ├── http.error.ts                   # HttpError - для HTTP контекста
│   ├── rpc.error.ts                    # RpcError - для RabbitMQ RPC контекста
│   ├── socket.error.ts                 # SocketError - для WebSocket контекста
│   ├── json-rpc.error.ts               # JsonRpcException - для JSON-RPC 2.0
│   └── nest-common.error.ts            # NestCommonError - базовый класс ошибок пакета
│
├── filters/                            # Глобальные фильтры обработки ошибок
│   ├── unified-exception.filter.ts     # UnifiedExceptionFilter - единый фильтр для HTTP и RPC
│   ├── json-rpc-exception.filter.ts    # JsonRpcExceptionFilter - фильтр для JSON-RPC 2.0
│   ├── http-exception-handler.ts       # HttpExceptionFilter - обработчик HTTP ошибок
│   └── rpc-exception-handler.ts        # RpcExceptionFilter - обработчик RPC ошибок с retry/DLX
│
├── interceptors/                       # Перехватчики для логирования запросов
│   ├── unified.interceptor.ts          # UnifiedInterceptor - единый перехватчик для HTTP, RPC и WebSocket
│   ├── response.interceptor.ts         # ResponseInterceptor - стандартизация формата HTTP ответов
│   ├── serialize.interceptor.ts        # SerializeInterceptor - сериализация ответов
│   ├── compression.interceptor.ts      # CompressionInterceptor - автоматическое сжатие больших ответов
│   └── request-id-response.interceptor.ts # RequestIdResponseInterceptor - добавление Request ID
│
├── base/                               # Базовые классы
│   └── base.controller.ts              # BaseController - базовый контроллер
│
├── guards/                             # Guards для контроля доступа
│   ├── jwt-auth.guard.ts               # JwtAuthGuard - проверка JWT токена
│   ├── api-key.guard.ts                # ApiKeyGuard - проверка API ключа
│   ├── roles.guard.ts                  # RolesGuard - проверка ролей пользователя
│   ├── permissions.guard.ts            # PermissionsGuard - проверка разрешений пользователя
│   ├── rate-limit.guard.ts             # RateLimitGuard - ограничение частоты запросов
│   └── websocket-auth.guard.ts         # WebSocketAuthGuard - проверка аутентификации WebSocket
│
├── decorators/                         # Декораторы для метаданных
│   ├── public.decorator.ts             # @Public() - пометка публичного эндпоинта
│   ├── roles.decorator.ts              # @Roles() - указание требуемых ролей
│   ├── permissions.decorator.ts        # @Permissions() - указание требуемых разрешений
│   ├── api-key.decorator.ts            # @ApiKey() - пометка эндпоинта как требующего API ключ
│   └── serialize.decorator.ts          # @Serialize() - указание DTO для сериализации
│
├── pipes/                              # Пайпы валидации
│   ├── http-validation.pipe.ts         # HttpValidationPipe - валидация DTO для HTTP
│   ├── rpc-validation.pipe.ts          # RpcValidationPipe - валидация DTO для RabbitMQ
│   ├── json-rpc-validation.pipe.ts     # JsonRpcValidationPipe - валидация JSON-RPC 2.0 запросов
│   ├── file-validation.pipe.ts         # FileValidationPipe - валидация загруженных файлов
│   ├── query-validation.pipe.ts        # QueryValidationPipe - валидация query параметров
│   └── header-validation.pipe.ts       # HeaderValidationPipe - валидация заголовков
│
├── utils/                              # Утилиты
│   ├── env-validator.ts                # validateEnv - валидация env переменных с Joi
│   ├── context.utils.ts                # Утилиты для работы с контекстом
│   ├── cors.utils.ts                   # createCorsOptions - создание опций CORS
│   ├── compression.utils.ts            # createCompressionOptions - создание опций compression
│   ├── versioning.utils.ts             # createVersioningOptions - создание опций версионирования
│   ├── file.utils.ts                   # Утилиты для работы с файлами
│   ├── circuit-breaker.ts              # CircuitBreakerService - реализация паттерна Circuit Breaker
│   └── get-service-path.ts             # getServicePath - определение пути в сервисе
│
├── types/                              # Типы
│   ├── http-response.ts                # Типы HTTP ответов (ErrorResponse, StandardResponse)
│   ├── rpc-types.ts                    # Типы RPC запросов/ответов
│   ├── json-rpc-types.ts               # Типы JSON-RPC 2.0 запросов/ответов
│   ├── json-rpc-error-codes.ts         # Коды ошибок JSON-RPC 2.0
│   ├── error-types.ts                  # Enum типов ошибок (ErrorType)
│   ├── context-types.ts                # Enum типов контекстов (ContextType) и типы пользователя
│   └── [другие типы]                   # Типы для файлов, circuit breaker, CORS, compression, versioning
│
└── index.ts                            # Публичный API (экспорты)
```

## Система обработки ошибок

Пакет предоставляет единую систему обработки ошибок для трех типов контекстов:
- **HTTP** - для HTTP контроллеров
- **RPC** - для RabbitMQ RPC запросов
- **WebSocket** - для Socket.io соединений

Все ошибки автоматически преобразуются между контекстами с сохранением типа и статус-кода.

### Принципы работы

1. **Глобальные фильтры** - все ошибки обрабатываются автоматически через глобальные фильтры
2. **Без catch блоков в контроллерах** - контроллеры не должны иметь try-catch блоков
3. **Автоматическое преобразование** - ошибки автоматически преобразуются между контекстами
4. **Сохранение типа и статуса** - тип ошибки и статус-код сохраняются при преобразовании

## Основные компоненты

### UnifiedExceptionFilter

Единый глобальный фильтр для обработки HTTP и RPC ошибок. Автоматически определяет тип контекста и использует соответствующий обработчик.

**Регистрация:**
```typescript
app.useGlobalFilters(new UnifiedExceptionFilter(logger, dlxExchange)); // dlxExchange опционально
```

**Логика работы:**
- HTTP контекст → `HttpExceptionFilter.handleException()` → преобразует в `HttpError`
- RPC контекст → `RpcExceptionFilter.handleException()` → преобразует в `RpcError` с retry/DLX логикой

### UnifiedInterceptor

Единый глобальный перехватчик для логирования HTTP и RPC запросов. Автоматически определяет тип контекста и использует соответствующий обработчик.

**Регистрация:**
```typescript
app.useGlobalInterceptors(new UnifiedInterceptor(logger));
```

**Логика работы:**
- HTTP контекст → `HttpLoggingInterceptor.intercept()`
- RPC контекст → `RpcLoggingInterceptor.intercept()`
- WebSocket контекст → `WebSocketLoggingInterceptor.intercept()`

### Классы ошибок

**HttpError** - для HTTP контекста
- Автоматически преобразует `RpcException`/`RpcError` в HTTP ошибку
- Сохраняет правильный HTTP статус-код
- Метод: `HttpError.fromUnknown(error, descriptionPrefix?)`

**RpcError** - для RabbitMQ RPC контекста
- Автоматически определяет тип ошибки (временная/постоянная)
- Используется в `RpcExceptionFilter` для retry/DLX логики
- Метод: `RpcError.fromUnknown(error)`
- Метод: `isTransient(): boolean`

**SocketError** - для WebSocket контекста
- Используется для обработки ошибок при отправке событий через Socket.io
- Метод: `SocketError.fromUnknown(error)`

**JsonRpcException** - для JSON-RPC 2.0 протокола
- Поддерживает стандартные коды ошибок JSON-RPC 2.0
- Автоматически маппит HTTP статусы на JSON-RPC коды ошибок
- Методы: `JsonRpcException.fromHttpException()`, `JsonRpcException.fromError()`

### BaseController

Базовый контроллер для всех контроллеров проекта. Предоставляет метод `acknowledge(ctx: RmqContext)` для подтверждения RPC сообщений.

### Пайпы валидации

- **HttpValidationPipe** - валидация DTO для HTTP контроллеров
- **RpcValidationPipe** - валидация DTO для RabbitMQ (автоматически извлекает correlationId и correlationTimestamp)
- **JsonRpcValidationPipe** - валидация JSON-RPC 2.0 запросов
- **FileValidationPipe** - валидация загруженных файлов
- **QueryValidationPipe** - валидация query параметров
- **HeaderValidationPipe** - валидация заголовков

### Guards

- **JwtAuthGuard** - проверка JWT токена
- **ApiKeyGuard** - проверка API ключа (работает с декоратором `@ApiKey()`)
- **RolesGuard** - проверка ролей пользователя (работает с декоратором `@Roles()`)
- **PermissionsGuard** - проверка разрешений пользователя (работает с декоратором `@Permissions()`)
- **RateLimitGuard** - ограничение частоты запросов
- **WebSocketAuthGuard** - проверка аутентификации WebSocket

### Декораторы

- `@Public()` - пометка публичного эндпоинта
- `@Roles(...)` - указание требуемых ролей
- `@Permissions(...)` - указание требуемых разрешений
- `@ApiKey()` - пометка эндпоинта как требующего API ключ
- `@Serialize(DtoClass)` - указание DTO для сериализации ответа

### Утилиты

- `validateEnv(env, requiredKeys)` - валидация переменных окружения с Joi
- `getUserFromContext(context)` - извлечение пользователя из контекста
- `getIpFromContext(context)` - извлечение IP адреса из контекста
- `getRequestIdFromContext(context)` - извлечение Request ID из контекста
- `createCorsOptions(options?)` - создание опций CORS
- `createCompressionOptions(options?)` - создание опций compression
- `createVersioningOptions(options)` - создание опций версионирования
- `validateFile(file, options?)` - валидация файла
- `CircuitBreakerService` - реализация паттерна Circuit Breaker
- `getServicePath(options)` - определение пути в сервисе

## Порядок использования

### HTTP контроллер

```typescript
@Controller("test")
export default class TestController extends BaseController {
    @Get("data")
    async getData() {
        // БЕЗ try-catch - глобальный фильтр все обработает
        return await this.testService.getData();
    }
}
```

### RPC контроллер

```typescript
@Controller()
export default class TestController extends BaseController {
    @MessagePattern("test.pattern")
    async getData(@Payload() dto: TestRequestDto, @Ctx() ctx: RmqContext) {
        const data = await this.testService.getData();
        this.acknowledge(ctx);
        return data;
    }
}
```

### WebSocket Gateway

```typescript
async publish(userId: string, event: SOCKET_EVENTS, payload: unknown) {
    try {
        await this.io.timeout(5000).to(`user:${userId}`).emitWithAck(event, payload);
    } catch (error) {
        const socketError = SocketError.fromUnknown(error);
        this.logger.error(`Ошибка отправки события: ${socketError.message}`);
        throw socketError;
    }
}
```

## Важные замечания

1. **Порядок регистрации**: UnifiedExceptionFilter и UnifiedInterceptor должны быть зарегистрированы глобально в `main.ts`
2. **Без catch блоков в контроллерах**: Контроллеры не должны иметь try-catch блоков - глобальный фильтр все обработает
3. **Автоматическое преобразование**: Ошибки автоматически преобразуются между контекстами с сохранением типа и статус-кода
4. **RpcValidationPipe**: Автоматически извлекает `correlationId` и `correlationTimestamp` из сообщения перед валидацией
5. **Guards**: Используются с соответствующими декораторами (`@Roles()`, `@Permissions()`, `@ApiKey()`)
6. **JsonRpcExceptionFilter**: Используется для обработки JSON-RPC 2.0 запросов отдельно от UnifiedExceptionFilter

## Тестирование

Пакет имеет 100% покрытие тестами. Все компоненты протестированы через Jest.

## Зависимости

- `@nestjs/common` - NestJS core
- `@nestjs/microservices` - NestJS microservices (для RpcException)
- `@nestjs/websockets` - NestJS WebSocket (для Socket.io)
- `@makebelieve21213-packages/logger` - Логирование
- `class-validator` - Валидация DTO
- `class-transformer` - Трансформация объектов
- `joi` - Валидация переменных окружения
- `rxjs` - Reactive extensions
